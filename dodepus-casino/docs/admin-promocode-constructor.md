# Конструктор промокодов (admin/promocode-create)

Документ описывает обновлённый экран создания промокода в админке. Ниже перечислены все блоки конструктора, подсказки по заполнению и то, как данные сохраняются в `local-sim`.

## Структура модулей
- UI разбит по папкам: `hooks/usePromoConstructor.js` хранит логику формы, а каждая секция лежит в `sections/*Section.jsx` (один файл — одна функциональная часть).
- local-sim разложен на `core/*` (хелперы, хранилище, события) и `api/*` (файлы для create/list/get/update). Публичный `index.js` теперь только реэкспортирует функции.

## 1. Карточка заголовка
- Короткое описание сценария: выберите тип промо, настройте параметры, сохраните в локальный симулятор.
- Экран теперь делится на две колонки: слева — форма, справа — справочник типов и сводка.

## 2. Базовые параметры
- **Тип промокода** — выпадающий список с определениями из `local-sim/admin/features/promo/definitions`. При смене типа заполняются seed-значения: награды, ограничения, расписание, аудитория.
- **Статус** — варианты соответствуют `ADMIN_PROMOCODE_STATUS_LABELS`. Значение уходит в поле `status`.
- **Код** — обязательное поле, сохраняется в `code`. Символы нормализуются в local-sim (верхний регистр и подчёркивания).
- **Название** — произвольный заголовок, попадает в `title`.

## 3. Конструктор награды
- Основные настройки (`currency`, `balanceType`) управляют полями `params.reward.currency` и `params.reward.balanceType`.
- Включаемые блоки:
  - **Процент на депозит** — поля `depositPercent`, `depositMaxAmount`.
  - **Фиксированная сумма** — поле `cashAmount`.
  - **Фриспины** — `freeSpins`, `freeSpinsValue`, `freeSpinsGame`.
  - **Пользовательский текст** — `customText`.
- Включение/выключение блоков управляет сохранением данных: выключенный блок чистит связанные поля.
- Автосборка формирует человеко-читаемое описание (`preview`). При желании текст награды можно переписать вручную — пока не нажать «Подставить автосборку», поле не перезаписывается.

## 4. Ограничения и сроки
- **Лимит активаций** (`limit`), **вейджер** (`wager`) и **кеп** (`cashoutCap`). Пустые значения сохраняются как `null`.
- **Начало/окончание действия** записываются в `startsAt`/`endsAt`, а также в `params.schedule`.

## 5. Повторные активации
- Поля для лимита и задержки переводятся в `params.repeat.limit` и `params.repeat.delayHours`. Значения округляются и приводятся к безопасным числам.

## 6. Аудитория
- Поля «Сегменты», «Страны», «Уровни», «Теги» собирают списки (каждое значение через строку или запятую).
- Тумблеры «Только VIP» и «Только новые игроки» выставляют соответствующие флаги.
- Все данные попадают в `params.audience` и доступны в сводке на экране.

## 7. Дополнительные ограничения
- Минимальные/максимальные суммы депозитов и баланса → `params.limits.{minDeposit,maxDeposit,minBalance,maxBalance}`.
- «Повторов на игрока» → `params.limits.maxUsagePerClient` (целое число).
- Валюты: поле `currency` задаёт валюту ограничений, список разрешённых валют (`allowedCurrencies`) принимает несколько значений.

## 8. Отображение и каналы
- Тумблеры `highlight`, `showOnMain`, `showInStore` управляют одноимёнными флагами в `params.display`.
- Доп. поля: `highlightColor`, `badgeText`, `description`, `channels` (список площадок), также сохраняются в `params.display`.

## 9. Примечание
- Свободное текстовое поле `notes` — для условий и комментариев.

## 10. Сводка и справочник
- Сводка справа показывает ключевые параметры (тип, статус, награда, аудитория, ограничения, отображение, примечания). Каждое изменение формы сразу отражается в списке.
- Ниже находится блок справочника типов (`PromoTypesReference`) — краткое описание механики и примера оффера.

## 11. Поведение при сохранении
- Кнопка «Сохранить в local-sim» собирает payload и вызывает `createAdminPromocode`. В payload указываются:
  - Поля формы (`typeId`, `code`, `title`, `reward`, `status`, `limit`, `wager`, `cashoutCap`, `notes`, `startsAt`, `endsAt`).
  - Объект `params` со структурой `{ reward, schedule, repeat, audience, limits, display }`.
  - Дублирующие поля `audience`, `limits`, `display` — для совместимости.
- После успешного сохранения поле «Код» очищается, уведомление выводится во всплывающем Alert.

## 12. Кнопка «Очистить»
- Полностью сбрасывает форму и возвращает значения к дефолтным (`empty*Form`).

## 13. Где смотреть результат
- Созданный промокод сохраняется в local storage через local-sim (`local-sim/admin/features/promo/index.js`, который проксирует вызовы в `api/`).
- Для тестирования откройте список `admin/promocodes` — новый промокод появится с заполненными полями аудитории, ограничений и отображения.

---
Если нужна быстрая проверка, ориентируйтесь на сводку справа: она отображает ключевые параметры в том же виде, как они попадут в симулятор.

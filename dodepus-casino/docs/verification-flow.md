# Поток верификации: механика и правила

Документ описывает целостный поток проверки пользователя: какие сущности участвуют, как клиент и администратор взаимодействуют с системой, какие статусы существуют и по каким правилам они меняются. Материал собран на основе общего плана из `task.md` и предназначен для разработчиков интерфейсов и прикладной логики.

## 1. Базовые понятия

### 1.1 Направления верификации

Верификация разбита на четыре направления:

1. **Почта**
2. **Номер телефона**
3. **Адрес проживания**
4. **Документы**

Каждое направление независимое по данным и статусам, но участвует в общем прогрессе.

### 1.2 Статусы направления

* `◻️` — запроса нет. Пользователь может редактировать поля и отправить на проверку.
* `❓` — на проверке. Поля блокируются, доступна отмена до фактического начала обработки админом.
* `✅` — подтверждено. Поля заблокированы, направление учитывается в прогрессе.
* `❌` — отказано. Пользователь видит комментарий, поля снова доступны для правок и повторной отправки.

### 1.3 Прогресс

* Счетчик отображается как `x/4`, где `x` — количество направлений в статусе `✅`.
* Прогресс используется для отображения пользователю и для определения секции карточки в админке.

### 1.4 История

Каждое значимое действие заносится в историю:

* дата и время события;
* действие (отправил, отменил, подтвердил, отклонил, сбросил, исправил адрес и т.д.);
* комментарий (если есть);
* автор (клиент или админ). Имена админов показываются только в админке.

## 2. Клиентский поток (`profile/verification`)

### 2.1 Структура интерфейса

* `profile/verification/page` — страница, отображающая карточки направлений, прогресс и основные кнопки.
* `profile/verification/widgets` — индикаторы статусов, счетчик `x/4`, подсказки и блоки с ошибками.
* `profile/verification/forms` — формы для ввода данных по каждому направлению.
* `profile/verification/history` — лента событий по каждому направлению с текстовыми комментариями отказов.

### 2.2 Состояние и данные

* `profile/verification/state` хранит текущие статусы направлений, блокировки полей и мета-информацию (например, признак «обработка началась»).
* `profile/verification/services` взаимодействует с `local-sim/api`, получает текущее состояние и отправляет события.

### 2.3 Пользовательские действия

* **Отправить на проверку** — доступно при статусе `◻️` или `❌`, если выполнены предусловия (валидные данные). После клика статус → `❓`, поля блокируются, добавляется запись в историю.
* **Отменить запрос** — доступно только при статусе `❓`, пока обработка не начата. Статус возвращается в `◻️`, поля разблокируются, история фиксирует отмену.
* **Повторно отправить** — то же, что и «Отправить», но после статуса `❌`. Перед отправкой пользователь может отредактировать данные.
* **Просмотр истории** — отображается всегда, но без имен администраторов.

### 2.4 Предусловия для кнопки «Подтвердить»

* **Почта / Номер** — валидный формат и обязательность заполнения.
* **Адрес** — заполнены блоки: страна, город, адрес, а также Имя, Фамилия, Пол, Дата рождения (представлены в профиле).
* **Документы** — становятся доступны только после заполнения персональных данных. Отправка формирует запрос со статусом `❓`.
* При отсутствии данных пользователь видит подсказку и подсветку проблемного поля.

### 2.5 Блокировки полей

* Статусы `❓` и `✅` блокируют поля для редактирования.
* Статусы `◻️` и `❌` оставляют поля активными.
* Дополнительно кнопка «Отменить запрос» скрывается или дизейблится, если админ уже начал обработку.

## 3. Админский поток (`admin/verification`)

### 3.1 Структура интерфейса

* `admin/verification/page` — основной экран с четырьмя секциями (аккордеонами):
  * «Запросы» — заявки в статусах `❓`.
  * «Частичная верификация» — клиенты, у которых не все направления `✅`.
  * «Отказано» — клиенты с минимум одним направлением `❌`.
  * «Верифицировано» — клиенты с `4/4` подтверждений.
* `admin/verification/search` — глобальный поиск по имени, фамилии, почте, телефону или ID. Результат разворачивает соответствующую секцию и подсвечивает карточку.
* `admin/verification/cards` — карточка клиента с ID, временем, индикаторами направлений и прогрессом.
* `admin/verification/modal` — модальное окно с вкладками по направлениям. Вкладка показывает статус, данные, историю и доступные действия.

### 3.2 Состояние и сервисы

* `admin/verification/state` хранит списки клиентов по секциям и реагирует на решения админа.
* `admin/verification/services` синхронизируется с `local-sim/api`, записывает решения и историю, обновляет секции.

### 3.3 Действия администратора

* **Подтвердить** направление в статусе `❓`. После подтверждения направление получает `✅`, прогресс увеличивается, карточка может переместиться в другую секцию.
* **Отклонить** направление в статусе `❓`. Требуется комментарий, который увидит клиент. Статус → `❌`, карточка перемещается в секцию «Отказано».
* **Просмотр подтвержденных направлений** — для `✅` доступны только просмотр данных и истории. Исключение: для направления «Адрес» есть кнопка «карандаш» для правки форматирования (результат фиксируется в истории).
* **Сброс** направления в статусе `✅` (только в секции «Верифицировано»). Требует комментарий, меняет статус на `◻️`, уменьшает прогресс и переносит карточку в «Частичную».

### 3.4 Перемещение карточек между секциями

* После каждого решения или сброса пересчитывается прогресс `x/4`.
* **4/4 подтверждений** → карточка перемещается в «Верифицировано».
* **Не все подтверждено, но нет отказов** → «Частичная верификация».
* **Есть хотя бы один `❌`** → «Отказано» до повторной отправки пользователем.
* **Новый запрос в одном из направлений** из «Частичной» → карточка дополнительно отображается в «Запросах» на время проверки.

### 3.5 Поиск и фильтры

* Поиск разворачивает нужную секцию и подсвечивает карточку.
* Дополнительные фильтры по направлению и статусу помогают выделять заявки (например, «Номер = ❓»).

## 4. Локальная имитация БД (`local-sim`)

### 4.1 Структура

* `local-sim/tables` — условные таблицы: клиенты, направления, история.
* `local-sim/seed` — стартовые данные для демонстрации разных сценариев.
* `local-sim/logic` — правила, обеспечивающие корректное изменение статусов и подсчет прогресса.
* `local-sim/api` — интерфейс, через который клиент и админ читают и меняют состояние.

### 4.2 Назначение

* Обеспечить единое хранилище для обоих интерфейсов.
* Гарантировать применение тех же правил, которые будут использоваться при переходе на реальный сервер.
* Позволить тестировать сценарии без подключения к внешнему бэкенду.

## 5. Навигация и доступы

* В приложении должны быть маршруты: `profile/personal`, `profile/verification`, `admin/verification`.
* Главное меню/хедер содержит ссылки на профиль и админку. Доступ к админке есть только у пользователей с ролью «админ».
* Клиент видит только свои данные и статусы без имен админов. Админ видит всех клиентов и полную историю с указанием авторов.

## 6. Правила доступности и кнопок

* Все кнопки и поля отражают свой статус явным образом: запрещенные действия остаются видимыми, но недоступными (серые), с подсказкой «почему».
* Предусловия проверяются на клиенте, но окончательное состояние подтверждается после ответа `local-sim/api`.
* «Отменить запрос» доступна только до фактического начала обработки.

## 7. Сценарии тестирования

Минимальный чек-лист для ручного тестирования:

1. Регистрация по почте → добавление номера → подтверждение номера.
2. Регистрация по номеру → подтверждение почты.
3. Адрес: попытка отправки без обязательных полей → кнопка неактивна → заполнение → успешная отправка.
4. Отмена запроса на статусе `❓` → редактирование → повторная отправка.
5. Действия админа: подтверждение, отказ с комментарием → проверка перемещений между секциями.
6. Сброс из «Верифицировано» → прогресс падает (4/4 → 3/4), карточка возвращается в «Частичную».

## 8. Переход на реальный сервер

* При интеграции с настоящим API заменить слой `local-sim/api` на реальные запросы, сохранив названия статусов и правила.
* Убедиться, что история продолжает писаться и синхронизироваться на обоих экранах.
* Настроить проверку ролей и доступов на серверной стороне.

## 9. Готовность к демо

Система считается готовой, если:

* Админка загружается с четырьмя свернутыми секциями, поиск работает, карточки показывают ID и индикаторы.
* Клиент видит все четыре направления, может отправлять, отменять, повторять запросы и читать комментарии отказов.
* Перемещения карточек между секциями и счетчик прогресса следуют описанным правилам.
* Сброс из «Верифицировано» переводит карточку в «Частичную».
* История корректно отображается и у клиента (без имен админов), и у админа (с именами).


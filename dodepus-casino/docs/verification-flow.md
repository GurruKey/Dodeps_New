# Потоки верификации: клиент и админ-панель

Документ фиксирует текущее поведение пользовательских экранов `profile/personal`, `profile/verification` и админской панели `admin/verification`. Описания основаны на реализованной логике local-sim и клиентского UI.

## 1. Роли, модули, статусы

- **Роли:** клиент и администратор.
- **Модули:** почта, телефон, адрес, документы (личность).
- **Статусы модулей:**
  - ◻️ `idle` — модуль ещё не отправлялся на проверку.
  - ❓ `pending` — модуль отправлен и находится на проверке.
  - ✅ `approved` — модуль подтверждён.
  - ❌ `rejected` — модуль отклонён.
- Значения из старых данных (`partial`, `reset`, `processing` и т. п.) при загрузке нормализуются к ближайшему допустимому статусу (`pending` или `idle`).
- **Источник данных:** `local-sim` (API слоя для клиентского приложения).

## 2. Размещение интерфейсов

### Клиент

- `profile/personal`
  - Блок **Контакты** (e-mail, телефон).
  - Блок **Данные профиля**: имя, фамилия, пол, дата рождения, страна, город, адрес.
- `profile/verification`
  - **Карточки статусов** — четыре плитки по модулям с CTA «Подтвердить».
  - **Загрузка документов** — выбор назначения, типа документа и загрузка файлов.
  - **История** — хронология решений и список загруженных файлов.

### Администратор

- `admin/verification`
  - **Поиск** по ID, имени, фамилии, e-mail, телефону; ввод обрабатывается с дебаунсом ~400 мс и синхронизируется с параметром `?q=`.
  - **4 секции-аккордеона** (по умолчанию свёрнуты): Requests, Partial, Rejected, Verified. У каждой есть счётчик и кнопка «Обновить».
  - **Карточка пользователя**: ID, прогресс X/4, бейджи модулей, количество документов.
  - **Модалка проверки**: просмотр данных, работа с активным модулем, комментарий, управление статусом, дозаполнение профиля, история и файлы.

## 3. Клиент: блок «Контакты»

- Контакт, использованный при регистрации, заблокирован сразу.
- Второй контакт можно заполнить и сохранить — модуль станет доступен для отправки на `profile/verification`.
- Блокировки полей зависят от статуса модуля:
  - ◻️ (`idle`) / ❌ — поле редактируемо.
  - ❓ (`pending`) / ✅ — поле заблокировано до изменения статуса.

## 4. Клиент: «Данные профиля»

- Для адреса требуется заполнить страну, город и адрес, а также указать имя, фамилию, пол и дату рождения — именно эти данные попадут в карточку проверки.
- Для документов обязательны имя, фамилия, пол, дата рождения и загруженный документ, подтверждающий личность.
- Статусы влияют на доступность полей аналогично пункту выше: на ◻️/❌ поля доступны, на ❓/✅ — заблокированы.

## 5. Клиент: «Статусы верификации»

- Четыре карточки модулей показывают текущий статус и кнопку «Подтвердить».
- Логика появления CTA:
  - Почта / телефон — кнопка доступна, если поле заполнено валидным значением.
  - Адрес — требуется заполнить страну, город, адрес и базовые персональные данные (имя, фамилию, пол, дату рождения).
  - Документы — доступны только после заполнения персональных данных **и** загрузки хотя бы одного файла категории `identity`.
- Нажатие «Подтвердить» переводит модуль в ❓ (`pending`), блокируя связанные поля в `profile/personal`.

## 6. Клиент: «Загрузка документов»

- Можно выбрать назначение (адрес или личность) и тип документа.
- Принимаются файлы 1..N, доступен предпросмотр.
- Для направления «Документы» наличие хотя бы одного файла — обязательное условие отправки. Для адреса загрузка дополнительного подтверждения опциональна, но файлы тоже попадают в историю проверки.

## 7. Клиент: реакция на решение администратора

- ✅ — карточка зеленеет, фиксируется дата решения, поля остаются заблокированными до сброса модулей администратором.
- ❌ — карточка красная, показывается причина и дата, поля разблокируются, доступна повторная отправка: клиент снова нажимает «Подтвердить», после чего статус переходит в ❓ `pending`.

## 8. Админ: секции и карточки

- Секции Requests / Partial / Rejected / Verified свёрнуты по умолчанию, каждая со счётчиком и кнопкой «Обновить».
- Распределение карточек по секциям:
  - Есть ≥1 ❓ (`pending`) — Requests.
  - Нет ❓, есть ≥1 ✅, но не 4/4 — Partial.
  - Нет ❓, есть ≥1 ❌ — Rejected.
  - 4/4 ✅ — Verified.
- Карточка пользователя содержит только ID, прогресс, бейджи модулей и количество документов.
- **Бейджи модулей:** **серые (◻️)** — не кликаются; **жёлтые/красные** — активны для работы; **зелёные** — только просмотр истории.
- Клик по жёлтому/красному/зелёному открывает модалку нужного модуля; по серому — нет реакции.

## 9. Админ: модалка проверки

- Шапка: «ID → Модуль», цвет статуса активного модуля и кнопка закрытия.
- Данные для проверки: отображаются значения контактов и профиля, документы доступны для скачивания/просмотра.
- История показывает решения с автором и временем; в клиенте автор не раскрывается.
- Комментарий обязателен для действий «Подтвердить», «Отказать», «Сброс», «Правка».
- Активен только один модуль: зелёные статусы read-only, серые показываются без возможности действий.
- Доступные действия работают с активным модулем:
  - **Подтвердить** — переводит модуль в ✅ и фиксирует комментарий.
  - **Отказать** — переводит модуль в ❌.
  - **Правка профиля** — доступна **только для модулей «Адрес» и «Документы»**: администратор может дозаполнить поля перед решением (все изменения попадают в историю). Контакты (e-mail, телефон) в модалке не редактируются.
  - **Сброс** — доступен, если модуль в ✅:
    - из **модалки** сбрасывается **только активный модуль** (✅ → ◻️ `idle`);
    - в секции **Verified** на карточке пользователя можно выбрать **один или несколько модулей** и сбросить их разом.

## 10. Сброс и маршрутизация

- **Сброс** доступен двумя способами:
  1) в секции **Verified** — мультисброс выбранных модулей (с комментарием);
  2) из **модалки конкретного модуля** — сброс только активного (с комментарием).
- После сброса прогресс X/4 уменьшается, карточка переходит в Partial или, при мгновенной новой отправке, в Requests.
- Перемещение между секциями всегда вычисляется по актуальным статусам модулей.

## 11. Параллельные запросы и приоритеты

- Клиент может держать несколько модулей в ❓ (`pending`) одновременно — решения независимы.
- Если статусы смешанные, пока есть хотя бы один ❓ (`pending`), карточка остаётся в Requests.

## 12. Приватность и устойчивость

- Клиент видит только текст причины и дату отказа; имя администратора скрыто.
- Действия идемпотентны: повторное нажатие без смены статуса не приводит к дублированию.
- Все изменения фиксируются в истории и сохраняются в `local-sim`.

## 13. Матрица переходов статусов модулей

| Текущее состояние | Действие / событие                     | Кто инициирует | Следующее состояние | Комментарий |
|-------------------|----------------------------------------|----------------|---------------------|-------------|
| ◻️ `idle`         | Клиент нажимает «Подтвердить»          | Клиент         | ❓ `pending`        | Отправка запроса, поля блокируются. |
| ❓ `pending`      | Админ подтверждает модуль              | Админ          | ✅ `approved`       | Комментарий обязателен, история фиксируется. |
| ❓ `pending`      | Админ отклоняет модуль                 | Админ          | ❌ `rejected`       | Поля разблокируются, клиент видит причину. |
| ❌ `rejected`     | Клиент повторно отправляет запрос      | Клиент         | ❓ `pending`        | Требуется исправление данных или новая загрузка. |
| ✅ `approved`     | Админ выполняет сброс выбранных модулей | Админ          | ◻️ `idle`           | История фиксирует событие «Сброс», карточка уходит в Partial/Requests. |
| ✅ `approved`     | Админ оставляет без изменений           | Админ          | ✅ `approved`       | Поля остаются заблокированными. |
| Любой             | Клиент отменяет изменения до отправки  | Клиент         | Без изменений       | Черновые изменения не создают событий. |

Матрица отражает единичный модуль. Итоговый статус пользователя складывается из состояний всех четырёх модулей и влияет на размещение карточки в админских секциях.

## 14. Краткий глоссарий

- **Модуль верификации** — одна из проверок (почта, телефон, адрес, документы).
- **Запрос** — отправка конкретного модуля на проверку администратору.
- **Сброс** — административное действие, возвращающее подтверждённый модуль в исходное состояние.
- **История** — журнал событий: отправка, решения, сбросы, правки профиля.


# Поток верификации: фактическая механика

Документ сверяет требования из `task.md` с текущей реализацией и описывает, как именно работает верификация на клиенте, в админке и в `local-sim`.

## 1. Сопоставление с шагами плана

| Шаг плана | Что ожидалось | Что реализовано сейчас |
| --- | --- | --- |
| 1. Клиентская папка `profile/verification` | Отдельные подкаталоги `page`, `widgets`, `forms`, `state`, `actions`, `history`, `services`. | Фактическая структура: [`Verification.jsx`, `blocks/`, `index.js`]. Компоненты сгруппированы по блокам: статусы, загрузка документов, история. Отдельных директорий `forms/state/actions` нет, логика разбита внутри компонентов. |
| 2. Админка `admin/verification` | Секции-аккордеоны, поиск, карточки, модалка, отдельные каталоги `search/cards/modal/state/services`. | Структура соответствует функционально: [`Verification.jsx`] управляет поиском, группировкой и модалкой; секции вынесены в `blocks/`; бэйджи и модалка лежат в `components/`; состояние и загрузка инкапсулированы в `hooks/useAdminVerificationRequests.js`. |
| 3. `local-sim` | Таблицы, seed, логика, API. | Реализованы модули `local-sim/auth/profileActions.js` (клиентские действия) и `local-sim/admin/verification.js` (админские действия, эвенты). Seed разнесён по `local-sim/admin/clients.js` и `local-sim/auth/profileExtras`. |
| 4. Навигация | Маршруты `profile/personal`, `profile/verification`, `admin/verification`, ссылки в меню. | Все маршруты прописаны в `src/app/routes.jsx`. Значок прогресса отображается в `ProfileLayout.jsx`; пункт меню админки — в `AdminLayout.jsx`. |
| 5. Общие статусы | Символы ◻️/❓/✅/❌ для направлений, x/4, история. | Статусы представлены строками `idle`/`pending`/`approved`/`rejected` в `shared/verification/modules.js`, но визуально отображаются иконками круга/вопроса/галочки/креста в клиентском блоке статусов. История строится функцией `buildVerificationTimeline`. |
| 6–9. Клиентские блокировки, отмена, повторная отправка | Возможность отменить запрос в статусе ❓ и отправлять повторно после отказа. | Повторная отправка реализована: кнопка «Подтвердить» доступна при `idle` или `rejected`. Кнопки отмены нет — статус `pending` ожидает действия администратора. |
| 10–13. Работа админа, перемещения секций, поиск | Модалка с вкладками, подтверждение/отказ, история, поиск, фильтры. | Модалка [`VerificationRequestModal.jsx`] даёт режимы «Подтвердить», «Отклонить», «Сбросить» с выбором модулей, комментариями и историей. Поиск реализован строкой в `Verification.jsx`; отдельные фильтры по статусам не вынесены — используются группировки секций. |
| 14. Роли и доступы | Клиент без имён админов, админ видит имена. | Клиентский блок истории не показывает имена админов. В админской модалке отображается `reviewerName`. Ограничение доступа на уровне UI обеспечивается `AdminLayout.jsx` через конфиг ролей. |
| 15. Чек-лист тестов | Сценарии регистрации, отправки, отказа, сброса. | Все сценарии, кроме «отмена запроса», можно выполнить: предусмотрены проверки предусловий, повторная отправка, подтверждение, отказ, сброс. |
| 18–19. Переход на сервер и демо | Единые статусы, замена API, проверка истории, секции. | Логика централизована в `local-sim`. Для перехода нужно заменить вызовы `local-sim` на реальное API; интерфейсы уже реагируют на обновления через `ADMIN_VERIFICATION_EVENT`. |

## 2. Модель данных и статусов

### 2.1 Модули верификации

`shared/verification/modules.js` задаёт четыре ключа: `email`, `phone`, `address`, `doc` и человекочитаемые подписи. Эти же ключи использует и клиент, и админ.

### 2.2 Статусы

Статусы нормализуются функцией `normalizeStatus` в `modules.js` и хранятся как `idle`, `pending`, `approved`, `rejected`. Для отображения на клиенте применяются иконки: серый круг (`idle`), жёлтый вопрос (`pending`), зелёная галочка (`approved`), красный крест (`rejected`).

### 2.3 Агрегация статусов

`deriveModuleStatesFromRequests` строит карту модулей на основе всех заявок и их истории. `summarizeModuleStates` считает:

* `approved` — число модулей со статусом `approved`;
* `pending` и `rejected` — для выборки цветов и подсказок;
* `allApproved`, `hasPending`, `hasRejected` — для бейджа на странице профиля и группировки карточек в админке.

### 2.4 История

`buildVerificationTimeline` преобразует заявки и историю в события: отправка, обновление, сброс. Клиентский блок истории показывает дату/время, статус, список модулей и комментарии.

## 3. Клиентский интерфейс `profile/verification`

### 3.1 Общая страница

`Verification.jsx` рендерит три блока: статусы (`VerificationStatusBlock`), загрузку документов (`VerificationUploadBlock`), историю (`VerificationHistoryBlock`).

### 3.2 Статусы и отправка заявки

`VerificationStatusBlock`:

* Получает данные пользователя через `useAuth` и расчёт модулей через `useVerificationModules`.
* Для каждого модуля строит карточку со статусом, подсказкой и кнопкой «Подтвердить», если модуль готов (`isReady`) и текущий статус `idle` или `rejected`.
* Условие готовности:
  * `email` — строка почты длиной ≥ 3 символов.
  * `phone` — не менее 10 цифр.
  * `address` — заполнены страна, город, адрес, а также персональные данные: имя, фамилия, дата рождения (формат `YYYY-MM-DD`), пол (`male` или `female`).
  * `doc` — выполнены условия адреса плюс загружен документ категории `identity`.
* Кнопка отправки вызывает `submitVerificationRequest` из `useAuth`, который проксирует в `local-sim/auth/profileActions.submitVerificationRequest`. В запрос попадают только модули, готовые к отправке и не находящиеся в статусе `pending`/`approved`.
* После успешной отправки показывается toast «Запрос отправлен…». Ошибки выводятся в `Alert`.
* Сообщения под сеткой объясняют, почему действия недоступны: отсутствие данных, ожидание решения, наличие отказа.

### 3.3 Загрузка документов

`VerificationUploadBlock` позволяет выбрать категорию (`address` или `identity`), тип документа и загрузить файл. Файл читается как Data URL и передаётся в `addVerificationUpload` контекста `Auth`. Требование: выбрать тип документа до загрузки. Для адреса доступны интернет-/банковские выписки, для личности — паспорт/ID/ВНЖ.

### 3.4 История

`VerificationHistoryBlock` строит таблицу событий и таблицу загруженных документов. Статусы отображаются через `VERIFICATION_STATUS_LABELS`. Имена администраторов не выводятся.

## 4. Админский интерфейс `admin/verification`

### 4.1 Загрузка данных и поиск

`Verification.jsx` использует хук `useAdminVerificationRequests` для загрузки запросов через `local-sim/admin/verification.listAdminVerificationRequests`. При изменениях данных локальный симулятор посылает событие `ADMIN_VERIFICATION_EVENT`, на которое подписывается хук. Строка поиска фильтрует карточки по ID, имени, email, телефону и никнейму.

### 4.2 Группировка секций

Функция `buildUserEntries` собирает заявки по пользователям, вычисляет сводку и определяет секцию:

* `requests` — есть хотя бы один модуль в ожидании (`summary.hasPending`).
* `rejected` — есть отклонённые (`summary.hasRejected`).
* `verified` — все модули подтверждены (`summary.allApproved`).
* `partial` — остальные пользователи.

Каждая секция отображается аккордеоном (`VerificationRequestsBlock`, `VerificationPartialBlock`, `VerificationRejectedBlock`, `VerificationApprovedBlock`). Карточки показывают ID, бейджи модулей (`VerificationFieldBadges`), прогресс `approved / total` и метаданные (дата отправки, количество вложений).

### 4.3 Модалка заявки

`VerificationRequestModal` открывается в режимах:

* `approve` — для заявок в статусе `pending`. Админ отмечает, какие модули завершены (`completedSelection`), может поправить профиль (адрес, ФИО, дата рождения, пол) и добавить комментарий. При подтверждении вызывается `updateVerificationRequestStatus` со статусом `approved`; функция сама решает, переводить ли заявку в `approved` (если все отмечены) или оставлять `pending`.
* `reject` — выбирает модули из списка запрошенных, требует обязательный комментарий. Запрос сохраняется со статусом `rejected`, модули остаются в ожидании до повторной отправки пользователем.
* `reset` — доступен для завершённых модулей, чаще всего через секцию «Верифицировано». Выбранные модули очищаются функцией `resetVerificationRequestModules`, статус заявки становится `idle` (если всё сброшено) или `approved` (если остались подтверждённые модули).
* `view` — режим просмотра для завершённых или отклонённых заявок.

Модалка показывает историю решений (`ListGroup`), загруженные файлы и профиль пользователя. Поле «Карандаш для адреса» реализовано через редактирование полей адреса в режиме `approve`/`reject`.

### 4.4 Действия и состояния

* Подтверждение/отказ/сброс вызывают `updateVerificationRequestStatus` или `resetVerificationRequestModules`, которые сохраняют историю, обновляют профайл и транслируют событие `ADMIN_VERIFICATION_EVENT`.
* Ошибки действий отображаются в верхнем `Alert` на странице.
* Секции можно разворачивать/сворачивать независимо; последняя открытая секция хранится в состоянии `expandedSection`.

## 5. Локальный симулятор `local-sim`

### 5.1 Отправка заявки (клиент)

`submitVerificationRequest`:

1. Нормализует выбранные поля.
2. Пытается найти уже открытую заявку (не в статусе `approved`/`rejected`). Если нашёл — дописывает в неё новые модули, не затрагивая завершённые.
3. Если открытой заявки нет — создаёт новую с `status: 'pending'`, `requestedFields` и пустыми `completedFields`.
4. Сохраняет результат через `persistExtras` и возвращает обновлённые данные пользователю.

### 5.2 Решения администратора

`updateVerificationRequestStatus`:

* Нормализует статусы и список модулей.
* Объединяет `completedFields` и `requestedFields` с предыдущими значениями.
* Определяет итоговый статус: `rejected`, если есть отказ; `pending`, если остались незавершённые модули; `approved`, если все отмечены завершёнными.
* Создаёт запись истории (`createHistoryEntry`) с комментарием и информацией об администраторе.
* Сохраняет изменения и транслирует событие обновления и запись в журнал действий (`appendAdminLog`).

`resetVerificationRequestModules` очищает выбранные модули, добавляет запись `status: 'reset'` в историю и переключает заявку в `idle` или `approved`.

### 5.3 Подписки

`subscribeToAdminVerificationRequests` использует глобальный `EventTarget` для рассылки изменений между вкладками. Клиентская часть обрабатывает изменения через контекст `Auth`, админка — через хук `useAdminVerificationRequests`.

## 6. Проверка сценариев

| Сценарий | Выполнимость | Комментарий |
| --- | --- | --- |
| Отправка номера после регистрации по почте | Да | Заполнить номер (≥10 цифр) → кнопка «Подтвердить» для модуля «Телефон». |
| Подтверждение почты после регистрации по номеру | Да | Заполненная почта (≥3 символа) доступна для отправки. |
| Отправка адреса с неполными данными | Да | Пока не заполнены адрес и персональные данные, кнопка остаётся недоступной, показывается подсказка. |
| Повторная отправка после отказа | Да | После отказа модуль получает статус `rejected`, кнопка «Подтвердить» снова активна. |
| Отмена заявки на стадии проверки | Нет | В текущей реализации кнопки отмены нет, модуль остаётся в `pending` до решения админа. |
| Действия админа (подтверждение, отказ, комментарий) | Да | Реализованы в модалке `VerificationRequestModal`. |
| Сброс подтверждённых модулей | Да | Через секцию «Верифицировано» → `reset`. Прогресс пересчитывается. |

## 7. Готовность к демо

Для демонстрации требуется:

* Убедиться, что в стартовых данных `local-sim` есть пользователи с разными статусами (поставляется в `local-sim/admin/clients.js`).
* Проверить, что маршрут `/profile/verification` доступен для авторизованного пользователя и показывает три блока.
* В админке `/admin/verification` — секции по умолчанию свернуты, поиск работает, модалка открывается из любой секции.
* Прогресс `x/4` корректно обновляется в `ProfileLayout.jsx` при смене статусов.
* История событий видна пользователю, история с именами админов — в модалке.

## 8. Следующие шаги

* Добавить отмену заявки на клиенте, если это требование критично (шаги 6–9 плана).
* Вынести клиентскую логику в отдельные директории (`state`, `actions`), если нужна структура строго по плану.
* Реализовать дополнительные фильтры по статусам в админке (шаг 13).
* При переходе на реальный сервер заменить вызовы `local-sim` на HTTP-запросы, сохранив интерфейсы функций.

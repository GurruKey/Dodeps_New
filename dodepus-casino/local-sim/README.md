# Local-sim canonical structure

`local-sim/` выступает single source of truth для контрактов, данных и вспомогательных хелперов. После реорганизации каталог придерживается следующего правила: любые таблицы/маршруты описываются здесь в первую очередь, а остальные слои подтягивают готовые константы и снапшоты из общего слоя `modules/shared`.

## Каталоги

- `db/` — каноничные JSON-таблицы 1:1 с будущими SQL-таблицами.
- `types/` — TypeScript типы таблиц, снапшотов и контрактов (snake_case → camelCase), используются генераторами/миграциями.
- `routes/` — I/O-карты локальных REST-маршрутов.
- `database/` — мини-движок локальной БД (schema/engine/storage/seed).
- `modules/` — доменные пакеты с API/хранилищами. Каждый пакет имеет собственный `index.js`, а поверх есть центральный реэкспорт `modules/index.js`.
- `modules/shared/` — единые константы (`tables.js`) и прокси-доступ к локальной БД (`localDatabase.js`), чтобы исключить дублирование путей и названий таблиц.
- `scripts/` — утилиты валидации и сервисные скрипты (`validateCanonicalDataset.js`).

## Shared-слой

`modules/shared` экспортирует:

- `TABLES`, `TABLE_LIST`, `TABLE_PRIMARY_KEYS` — карта имён таблиц и их первичных ключей.
- Именованные константы (`AUTH_USERS_TABLE`, `VERIFICATION_QUEUE_TABLE` и т.д.) для доменных модулей.
- Хелперы локальной БД (`getLocalDatabase`, `resetLocalDatabase`, `applyLocalDatabaseSeed` ...), что позволяет импортировать их с коротких путей (`../../shared/localDatabase.js`).

Использование shared-слоя гарантирует, что любое добавление/переименование таблиц достаточно оформить в одном месте и автоматически получить корректные пути в schema/seed/validators.

## Потоки обновления

1. Фиксируем контракт/данные (`db/`, `types/`, `routes/`, `modules/shared/tables.js`).
2. Обновляем доменные модули, которые теперь подтягивают константы из shared.
3. Проверяем `npm run local-sim:validate` — скрипт использует `TABLES` для сообщений и связей, так что новые таблицы автоматически попадают в валидацию.

## Быстрый импорт

Для интеграции фронта и сидеров предусмотрен файл `modules/index.js`, который отдаёт доменные пакеты (например, `import { auth, shared } from 'local-sim/modules'`). Это упрощает подключение новых фич без глубоких относительных путей.

## Дальнейшее расширение

- Добавление таблицы: прописать её в `modules/shared/tables.js`, обновить JSON и типы, затем расширить миграции.
- Добавление маршрута: описать контракт в `routes/`, задокументировать в `migration-notes.md`, обновить доменный модуль.
- Любые SQL-миграции делаются после отражения изменений в local-sim.

# Отчёт: анализ фронтенда Dodepus Casino и план SQL-выходов к БД

Версия: draft (по коду v0.7)

Цель: перечислить все будущие точки выхода к базе данных (SQL), спроецированные на текущие экраны/функции фронтенда, предложить структуру БД, примеры ключевых запросов и рекомендации по дальнейшей интеграции.

---

## 1) Что есть сейчас (по коду)

- Чистый фронтенд на React + React Router + React-Bootstrap, Vite.
- Данные пользователя/кошелька/истории имитируются в `localStorage` через `AuthContext` (`src/app/AuthContext.jsx`).
- Игротека/провайдеры/категории — статический список (`src/data/games.js`), игры открываются из `/public/games/<provider>/<slug>/index.html`.
- Сетевые запросы есть только к статическим файлам (проверка обложек/iframe); запросов к API нет.
- Экраны: авторизация, лобби, профиль (кошелёк/терминал/история/персональные данные/верификация/промо/сезон/история игр), страница игры.

Вывод: для продакшн‑архитектуры нужен полноценный сервер + SQL‑БД, где фронт будет выполнять CRUD/бизнес‑операции вместо локальных мутаций в `localStorage`.

---

## 2) Карта экранов → будущие операции в БД

Ниже — точки, где фронтенд должен «выходить» к базе через API, и какие SQL‑операции за этим стоят.

1) Авторизация (`/login`, `/register`)
- POST регистрация: создание пользователя, профиля, дефолтного кошелька, запись сессии.
- POST логин: проверка учётных данных/идентификатора, создание/пролонгация сессии, обновление `last_login`.
- POST/GET подтверждение email/телефона: создание/проверка токенов подтверждения.
- POST/DELETE сессии: logout, отзыв refresh‑токенов.
- Дополнительно: лимиты попыток, учёт устройств/IP, 2FA (вкл/выкл, проверка TOTP).

2) Лобби/категории/провайдеры (`/lobby`, `/categories`, `/providers`, `/providers/:provider`)
- GET игры/категории/провайдеры, пагинация/фильтрация/поиск.
- GET рекомендации (по категории/популярности/истории игрока).

3) Страница игры (`/game/:provider/:slug`)
- POST начало сессии игры (фиксация user_id, game_id, ip/device).
- POST ставка/раунд: списание со счёта (ledger), запись раунда/ставки, расчёт результата, начисление выигрыша.
- PATCH окончание сессии (закрыть сессию, обновить длительность/статус).
- GET история по игре/сессии (для отладки/UX и ответов саппорта).

4) Профиль → Кошелёк (`/profile/wallet`)
- GET балансы (реальный, бонусный, «в игре»), вычисление выводимых средств.
- GET агрегаты (итоги, суммарные депозиты/выводы, незавершённые операции).

5) Профиль → Терминал (`/profile/terminal`)
- POST заявка на депозит (создать transaction=pending, инициация PSP/крипто‑инвойса).
- POST заявка на вывод (проверка withdrawable, блокировка средств на hold).
- Webhook PSP: PATCH/PUT обновление статуса транзакции, отражение в ledger.

6) Профиль → История (`/profile/history`)
- GET список транзакций (депозиты/выводы/начисления), сортировка/пагинация/фильтры.

7) Профиль → Персональные данные (`/profile/personal`)
- GET профиль пользователя (PII), GET статусы верификации/ограничений.
- PATCH отдельные поля (ник, ФИО, пол/дата рождения, соц. статус, адрес, телефон).
- POST запрос на верификацию email (послать письмо/токен), PATCH `email_verified`.

8) Профиль → Верификация (KYC) (`/profile/verification`)
- POST загрузка документов (метаданные в БД, файл в объектное хранилище), создание/привязка KYC‑кейса.
- GET история загрузок и статусов кейса/уровня KYC (pending/approved/rejected).

9) Промо/бонусы (`/profile/promos`)
- GET доступные промо/бонусы (активные по дате и условиям).
- POST получение бонуса (создание бонусного кошелька/запись grant, начисление, старт wager).
- GET прогресс отыгрыша и ограничения.

10) Сезон/Лидерборды (`/profile/season`)
- GET активные сезоны/правила.
- GET лидерборд (пагинация/ранг пользователя).
- Бэкграунд: обновление очков по событиям (ставки/выигрыши).

11) История игр (`/profile/games-history`)
- GET список сыгранных раундов/сессий, статусы, суммы ставок/выигрышей.

12) Админ (`/admin`)
- CRUD игры/категории/провайдеры.
- Модерация пользователей/балансов/транзакций/верификаций.
- Аудит действий, отчёты, риск‑сигналы.

---

## 3) Предлагаемая схема БД (основные сущности)

Пользователи и безопасность
- users(id, email UNIQUE, phone UNIQUE, password_hash, status, roles, created_at, last_login, locale)
- user_profiles(user_id PK/FK, nickname, first_name, last_name, gender, dob, social_status, country, city, address, updated_at)
- sessions(id, user_id, refresh_token_hash, ip, user_agent, created_at, last_seen_at, revoked_at)
- email_verifications(id, user_id, token_hash, expires_at, used_at)
- phone_verifications(id, user_id, code_hash, expires_at, used_at)
- mfa_secrets(user_id PK/FK, totp_secret, enabled_at)
- security_events(id, user_id, type, ip, user_agent, created_at)

KYC
- kyc_cases(id, user_id, level, status, created_at, updated_at, reason)
- kyc_documents(id, case_id, user_id, kind, mime, size, storage_url, uploaded_at)
- kyc_reviews(id, case_id, reviewer_id, decision, comment, created_at)

Деньги (кошельки/книги)
- wallets(id, user_id, currency, kind ENUM('real','bonus','in_game'), created_at)
- ledger_entries(id, wallet_id, amount NUMERIC(20,8), currency, type, ref_type, ref_id, status, created_at)
- wallet_locks(id, wallet_id, amount, reason, created_at, released_at)
- transactions(id, user_id, type ENUM('deposit','withdraw'), method, amount, currency, status, provider_tx_id, created_at, updated_at, metadata JSONB)
- payment_methods(id, user_id, kind, brand, last4, token, created_at)

Игры
- providers(id, name, slug UNIQUE)
- games(id, provider_id, slug UNIQUE, title, category, rtp, volatility, description)
- game_sessions(id, user_id, game_id, started_at, ended_at, ip, device)
- game_rounds(id, session_id, user_id, game_id, stake, currency, outcome ENUM('win','loss','push'), win_amount, started_at, finished_at, status)
- jackpots(id, scope, pool_amount, contribution_rate, updated_at)
- jackpot_contributions(id, round_id, amount)

Промо/бонусы/лидерборды
- promotions(id, slug UNIQUE, title, description, start_at, end_at, active, bonus_type, bonus_value, wager_mult, max_win, min_deposit, terms_url)
- promo_grants(id, promo_id, user_id, status, granted_at, activated_at, expires_at)
- bonus_wallets(id, user_id, promo_grant_id, balance, wager_remaining, expires_at)
- leaderboard_seasons(id, slug UNIQUE, name, start_at, end_at, rules JSONB)
- leaderboard_entries(season_id, user_id, points, rank, updated_at, PRIMARY KEY(season_id, user_id))

Коммуникации/аудит
- notifications(id, user_id, title, body, kind, read_at, created_at)
- audit_log(id, actor_type, actor_id, action, target_type, target_id, meta JSONB, created_at)

Индексы и ограничения (минимум)
- users.email/phone UNIQUE; sessions(user_id), sessions(last_seen_at);
- wallets(user_id, currency, kind) UNIQUE; ledger_entries(wallet_id, created_at);
- transactions(user_id, created_at), transactions(status);
- game_rounds(user_id, created_at), game_sessions(user_id, started_at);
- promotions(active, start_at, end_at); leaderboard_entries(points DESC);

---

## 4) Ключевые SQL‑операции (примеры)

Регистрация пользователя
```sql
-- 1) users
INSERT INTO users (id, email, password_hash, status, created_at)
VALUES (gen_random_uuid(), $1, $2, 'active', now())
RETURNING id;

-- 2) профиль + кошельки
INSERT INTO user_profiles (user_id, nickname) VALUES ($user_id, $nickname);
INSERT INTO wallets (id, user_id, currency, kind, created_at)
VALUES (gen_random_uuid(), $user_id, 'USD', 'real', now());
```

Логин/сессия
```sql
SELECT id, password_hash FROM users WHERE email = $1 AND status = 'active';
-- после проверки пароля:
INSERT INTO sessions (id, user_id, refresh_token_hash, ip, user_agent, created_at)
VALUES (gen_random_uuid(), $user_id, $rt_hash, $ip, $ua, now());
UPDATE users SET last_login = now() WHERE id = $user_id;
```

Обновление персональных данных
```sql
UPDATE user_profiles
SET nickname = COALESCE($1, nickname),
    first_name = COALESCE($2, first_name),
    last_name  = COALESCE($3, last_name),
    gender     = COALESCE($4, gender),
    dob        = COALESCE($5, dob),
    social_status = COALESCE($6, social_status),
    country = COALESCE($7, country),
    city    = COALESCE($8, city),
    address = COALESCE($9, address),
    updated_at = now()
WHERE user_id = $user_id;
```

Запрос верификации email
```sql
INSERT INTO email_verifications (id, user_id, token_hash, expires_at, created_at)
VALUES (gen_random_uuid(), $user_id, $token_hash, now() + interval '24 hours', now());
```

Загрузка KYC‑документа
```sql
-- гарантируем кейс
INSERT INTO kyc_cases (id, user_id, level, status, created_at)
VALUES (gen_random_uuid(), $user_id, 'basic', 'pending', now())
ON CONFLICT (user_id) DO UPDATE SET updated_at = now()
RETURNING id AS case_id;

-- метаданные файла
INSERT INTO kyc_documents (id, case_id, user_id, kind, mime, size, storage_url, uploaded_at)
VALUES (gen_random_uuid(), $case_id, $user_id, $kind, $mime, $size, $url, now());
```

Создание депозита (инициация)
```sql
INSERT INTO transactions (id, user_id, type, method, amount, currency, status, created_at)
VALUES ($tx_id, $user_id, 'deposit', $method, $amount, $ccy, 'pending', now());
```

Завершение депозита (webhook PSP → начисление)
```sql
BEGIN;
UPDATE transactions SET status = 'success', updated_at = now()
WHERE id = $tx_id AND status = 'pending';

-- ledger постинг
INSERT INTO ledger_entries (id, wallet_id, amount, currency, type, ref_type, ref_id, status, created_at)
VALUES (gen_random_uuid(), $wallet_id, $amount, $ccy, 'deposit', 'transaction', $tx_id, 'posted', now());
COMMIT;
```

Инициирование вывода (с проверкой доступного остатка)
```sql
-- вычисление withdrawable делается на сервере (баланс – холды – бонусные ограничения)
INSERT INTO transactions (id, user_id, type, method, amount, currency, status, created_at)
VALUES ($tx_id, $user_id, 'withdraw', $method, $amount, $ccy, 'pending', now());

-- блокировка средств
INSERT INTO wallet_locks (id, wallet_id, amount, reason, created_at)
VALUES (gen_random_uuid(), $wallet_id, $amount, 'withdraw', now());
```

Проведение ставки/раунда игры
```sql
BEGIN;
-- 1) создать раунд
INSERT INTO game_rounds (id, session_id, user_id, game_id, stake, currency, status, started_at)
VALUES ($round_id, $session_id, $user_id, $game_id, $stake, $ccy, 'pending', now());

-- 2) списать ставку
INSERT INTO ledger_entries (id, wallet_id, amount, currency, type, ref_type, ref_id, status, created_at)
VALUES (gen_random_uuid(), $wallet_id, -$stake, $ccy, 'bet', 'game_round', $round_id, 'posted', now());

-- 3) рассчитать исход, начислить выигрыш (если > 0)
UPDATE game_rounds SET outcome = $outcome, win_amount = $win, status = 'finished', finished_at = now()
WHERE id = $round_id;
INSERT INTO ledger_entries (id, wallet_id, amount, currency, type, ref_type, ref_id, status, created_at)
SELECT gen_random_uuid(), $wallet_id, $win, $ccy, 'win', 'game_round', $round_id, 'posted', now()
WHERE $win > 0;
COMMIT;
```

История транзакций пользователя
```sql
SELECT id, type, method, amount, currency, status, created_at
FROM transactions
WHERE user_id = $user_id
ORDER BY created_at DESC
LIMIT $limit OFFSET $offset;
```

Лидерборд
```sql
SELECT user_id, points, RANK() OVER (ORDER BY points DESC) AS rank
FROM leaderboard_entries
WHERE season_id = $season
ORDER BY points DESC
LIMIT $limit OFFSET $offset;
```

---

## 5) Дополнения на будущее (что учесть заранее)

- Денежная модель
  - Отделить кошельки: real, bonus, in_game; все движения — только через ledger (источник истины).
  - Поддержка мультивалютности: единый NUMERIC, аккуратное округление на краях.
  - Идемпотентность всех платёжных операций (idempotency_key на API и уникальные ref_id в ledger).

- Безопасность/комплаенс
  - 2FA (TOTP), защита сессий, привязка устройств/гео, лимиты попыток.
  - KYC/AML уровни, источники средств (SoF), аудит админ‑действий.
  - Ограничения ответственной игры: дневные/недельные лимиты, тайм‑ауты, самоисключение.

- Игровая логика
  - Прозрачный RNG/seed‑based провайдер (серверная генерация, валидация раундов), защита от манипуляций с клиентским iframe.
  - Джекпоты (взносы с каждой ставки), провайдер‑сплит RTP.

- Промо/бонусы
  - Вейджер: списание ставки в счёт отыгрыша, ограничения по слотам/ставкам/срокам.
  - Капы на макс. выигрыш/кэш‑аут бонуса, экспирация бонусного кошелька.

- Аналитика/события
  - Сырой событийный лог (bet_placed, bet_settled, deposit_succeeded…) для отчётов и антифрода.

- Техдолг/эксплуатация
  - Полные миграции (Liquibase/Flyway), сиды справочников (провайдеры/категории).
  - Набор индексов, регулярный вакуум/архив историй, партиционирование ledger/rounds при росте.

---

## 6) Рекомендации по интеграции (фидбек по коду)

- AuthContext
  - Заменить localStorage‑мутаторы на вызовы API: login/register/logout, getProfile/updateProfile, getBalances.
  - Хранить только access‑token в памяти (или httpOnly cookie), refresh — в защищённой cookie.
  - Все суммы/балансы получать из API; операции депозита/вывода/ставок — строго серверные транзакции.

- Страницы профиля
  - «Сохранить» (SavePersonalBlock) должен вызывать PATCH `/me/profile` — частичное обновление.
  - Блоки верификации: upload → S3/GCS (pre‑signed URL), в БД — только метаданные и ссылки.
  - История: пагинация, фильтры по типу/статусу/диапазону дат.

- Игры
  - Переезд от статических iframes к интеграции с игровым движком/агрегатором через бэкенд‑прокси.
  - Все ставки/выигрыши учитывать в БД атомарно (BEGIN…COMMIT) с идемпотентностью.

- Данные/типизация
  - Валюты и числа: NUMERIC в БД, на фронте — форматирование только для UI.
  - Даты/время — ISO UTC, конвертация на клиенте.

- API‑контракты
  - Стабильные DTO: User, Profile, BalanceSummary, Transaction, GameRound, PromoGrant, LeaderboardEntry.
  - Версионирование API (`/api/v1`), коды ошибок, трассировка запросов.

---

## 7) Быстрые SQL‑чек‑листы по экранам (резюме)

- Login/Register: SELECT/INSERT users, INSERT sessions, email/phone verify tokens.
- Wallet: SELECT суммарных балансов по кошелькам + вычисление withdrawable; SELECT последних операций.
- Terminal: INSERT transactions (pending), INSERT wallet_locks, обновление по webhook PSP.
- History: SELECT transactions ORDER BY created_at DESC LIMIT/OFFSET.
- Personal: SELECT/UPDATE user_profiles; email verify (INSERT token → PATCH users.email_verified).
- Verification: INSERT kyc_documents, UPSERT kyc_cases, SELECT история.
- Game: INSERT game_sessions; для каждого раунда — INSERT game_rounds, 2 ledger‑вставки (bet/win), UPDATE round.
- Promos: SELECT promotions; при активации — INSERT promo_grants, CREATE bonus_wallet, INSERT ledger bonus, старт wager.
- Season: SELECT leaderboard, UPDATE points по событиям.
- Admin: CRUD игр/провайдеров/категорий, модерация users/kyc/transactions, audit_log.

---

## 8) Следующие шаги

1. Утвердить доменную модель (таблицы/поля/ограничения) и выбрать СУБД (PostgreSQL рекомендована).
2. Подготовить миграции (создание основных таблиц, индексы, сиды справочников).
3. Спроектировать REST API (`/api/v1`) и контракты DTO; начальный бэкенд: Auth, Profile, Wallet, Transactions.
4. Перевести фронтенд на вызовы API (AuthContext → fetch/axios + SWR/RTK Query по желанию).
5. Подключить PSP (sandbox) и настроить webhook → транзакции/ledger.
6. Постепенно переносить игровые действия в серверную логику (rounds/ledger), добавить лидерборды/промо.

---

Если нужен, могу детализировать миграции под PostgreSQL и расписать JSON‑контракты для каждого эндпоинта.

